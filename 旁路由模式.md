
# OpenWrt "IPTV 旁路由" 完整配置指南 (WAN 口作 IPTV 口)

## 1\. 目标与网络拓扑

  * **目标**: 将一台全新的 OpenWrt 路由器配置为 `192.168.0.210`，作为“IPTV 旁路由”，为 `192.168.0.x` 主网络提供 `igmpproxy` 和 `udpxy` 直播服务。
  * **主路由**:
      * IP 地址: `192.168.0.1`
      * 功能: 负责 DHCP、Wi-Fi 和主要上网。
  * **OpenWrt 旁路由 (本机)**:
      * `LAN` 口 (LAN 1, LAN 2...): 将全部作为 `lan` 口（用于连接主路由、电脑、机顶盒）。
      * `WAN` 口: 将作为 **`IPTV` 专用口**（用于连接光猫的 IPTV 专线）。
      * 新 IP 地址: `192.168.0.210`
  * **所有设备 (电脑, 机顶盒)**:
      * 全部连接到**主路由** (`192.168.0.x`)。

-----

## 2\. LuCI (网页) 手动设置步骤

### 步骤一：准备工作 (初始化)

1.  **物理连接**: 电脑**直连** OpenWrt 路由器的 **`LAN 1`** 口。
2.  **登录系统**: 浏览器访问 **`192.168.1.1`** 并登录。
3.  **安装必备包 (并修复 udpxy 脚本)**:
      * （临时将 OpenWrt 的 `WAN` 口连上主路由以获取网络）
      * 前往 `系统` -\> `软件包`，点击 `刷新列表`。
      * **搜索并安装** `igmpproxy`。
      * **搜索并安装** `luci-app-udpxy`。
      * **【关键修复】** 由于 `udpxy` 启动脚本可能丢失，请通过 `系统` -\> `TTYD 终端` (或 SSH) 登录，运行以下命令**强制修复**：
        ```sh
        opkg install luci-app-udpxy --force-reinstall
        ```
        *(提示 `conffile` 错误是正常的，可以忽略)*
4.  **检查交换机 (VLAN)**:
      * 前往 `网络` -\> `交换机`。
      * 确认您的配置为**默认配置** (即 `image_5f354c.png`)：
          * **VLAN 1**: `CPU(已标记)`, `LAN 1(未标记)`, `LAN 2(未标记)`。
          * **VLAN 2**: `CPU(已标记)`, `WAN(未标记)`。
      * **此配置无需修改。**

### 步骤二：配置网络接口 (旁路由核心)

**【警告】：** 此步骤中，在最后一步 "保存并应用" 之前，只点击 `保存`。

1.  前往 `网络` -\> `接口`。
2.  **修改 `lan` 接口**:
      * 点击 `lan` 的 `修改`。
      * **常规设置**:
          * `协议`: `静态地址`
          * `IPv4 地址`: `192.168.0.210`
          * `IPv4 网关`: `192.168.0.1`
          * `DNS 服务器`: `192.168.0.1`
      * **DHCP 服务器**: **勾选 `忽略此接口`**。
      * 点击 `保存`。
3.  **删除 `wan` 接口**:
      * 找到 `wan` 和 `wan6` 接口，点击 `删除`。
4.  **创建 `IPTV` 接口**:
      * 点击 `添加新接口...`
      * `名称`: **`IPTV`** (请记住大小写)
      * `协议`: `DHCP 客户端`
      * `设备`: **`eth0.2`** (即 `WAN` 物理口)
      * 点击 `创建接口`。
5.  **编辑 `IPTV` 接口**:
      * **高级设置**: **取消勾选** `使用默认网关`，`跃点` 填 `20`。
      * **防火墙设置**: 分配新区域 **`iptv`** (全小写)。
      * 点击 `保存`。

### 步骤三：配置 `igmpproxy`

1.  前往 `服务` -\> `IGMP 代理` (或通过 SSH 配置)。
2.  勾选 `启用`。
3.  `上游接口`: `IPTV`。
4.  `下游接口`: `lan`。
5.  点击 `保存`。

### 步骤四：配置 `udpxy` (修复 BUG)

**这是最关键的步骤，请严格执行。**

1.  前往 `服务` -\> `udpxy`。
2.  勾选 `已启用`。
3.  `Bind IP/Interface`: **【警告】\<u\>必须留空！\</u\>** (您系统上的 `udpxy` 不支持此选项)。
4.  `端口`: `4022`
5.  `Source IP/Interface`: **`eth0.2`**
6.  点击 **`保存并应用`**。
7.  **【关键修复】** `udpxy` 服务**现在仍然是崩溃的** (`crash loop`)，因为 LuCI 即使在留空时也可能写入了错误的 `bind` 配置。
8.  请**立即**通过 `系统` -\> `TTYD 终端` (或 SSH) 登录 `192.168.1.1` (或 `192.168.0.210`，取决于您是否已应用)，运行以下命令\*\*\<u\>彻底删除\</u\>有毒的配置\*\*：
    ```sh
    # 打开配置文件
    vi /etc/config/udpxy

    # 在 vi 编辑器中，找到 `option bind ...` 这一行，按 `dd` 删除它。
    # 确保文件内容如下：
    # config udpxy 'udpxy'
    #     option disabled '0'
    #     option respawn '1'
    #     option status '1'
    #     option port '4022'
    #     option source 'eth0.2'

    # 按 Esc，输入 :wq 保存退出

    # 立即重启服务
    /etc/init.d/udpxy restart
    ```

### 步骤五：配置防火墙

1.  前往 `网络` -\> `防火墙`。
2.  **`iptv` 区域设置**:
      * `IP 动态伪装`: **勾选**。
      * `MSS 钳制`: **勾选**。
      * `允许转发到目标区域`: **`lan`**。
3.  **`通信规则`** 选项卡:
      * **规则 1 (Allow-IGMP)**: `协议: IGMP`, `源区域: iptv`, `目标区域: 设备 (输入)`, `操作: 接受`。
      * **规则 2 (Allow-Multicast)**: `协议: UDP`, `源区域: iptv`, `目标区域: lan`, `目标地址: 224.0.0.0/4`, `操作: 接受`。
      * **规则 3 (Allow-udpxy-LAN)**: `协议: TCP`, `源区域: lan`, `目标区域: 设备 (输入)`, `目标端口: 4022`, `操作: 接受`。
4.  点击 **`保存并应用`**。

### 步骤六：切换连接并验证

1.  **拔掉**您电脑和 OpenWrt `LAN 1` 口的直连网线。
2.  **OpenWrt `LAN 1` 口** -\> 连接到**主路由 (`192.168.0.1`)** 的 `LAN` 口。
3.  **OpenWrt `WAN` 口** -\> 连接到**光猫**的 `IPTV` 专用口。
4.  **您的电脑** -\> 连接回**主路由**的 `LAN` 口或 Wi-Fi。
5.  **验证**:
      * 在电脑浏览器访问 OpenWrt 的**新地址**: **`http://192.168.0.210`**。
      * 访问 `udpxy` 状态页: **`http://192.168.0.210:4022/status`** (此时应可访问)。
      * **播放地址**: `http://192.168.0.210:4022/rtp/[组播地址]:[端口]`
      * **机顶盒**: 连接到**主路由**的 `LAN` 口。

-----

## 3\. 一键配置脚本 (包含所有 BUG 修复)

**前提**：

1.  您处于**全新系统**状态 (`192.168.1.1`)。
2.  您已通过 `opkg` **安装**了 `igmpproxy` 和 `luci-app-udpxy`。
3.  您的交换机配置为**默认状态** (`WAN`口=VLAN 2)。

通过 SSH 登录 `192.168.1.1`，**一次性复制并粘贴**以下所有命令，然后按回车。

```sh
#!/bin/sh
# ===================================================================
# OpenWrt "IPTV 旁路由" 一键配置脚本 (V3 - 最终修复版)
# 适配: WAN 口作为 IPTV 口, 修复了 'bind' 选项崩溃和脚本丢失问题
# 假设: 主路由 192.168.0.1, 本机将设为 192.168.0.210
# ===================================================================

echo "--- 步骤 1: 检查 VLAN 设备 (前提) ---"
if [ ! -d "/sys/class/net/eth0.1" ] || [ ! -d "/sys/class/net/eth0.2" ]; then
    echo "错误：未找到 'eth0.1' (LAN) 或 'eth0.2' (WAN/IPTV) 设备。"
    echo "请确认交换机为默认配置。"
    exit 1
fi
echo "VLAN 检查通过！"
sleep 2

echo "--- 步骤 2: 修复 udpxy 启动脚本 (如果丢失) ---"
opkg install luci-app-udpxy --force-reinstall

echo "--- 步骤 3: 配置 'lan' 接口 (旁路由核心) ---"
uci set network.lan.device='eth0.1'
uci set network.lan.proto='static'
uci set network.lan.ipaddr='192.168.0.210' # <--- 您的 IP
uci set network.lan.netmask='255.255.255.0'
uci set network.lan.gateway='192.168.0.1'
uci set network.lan.dns='192.168.0.1'
uci -q delete network.lan.ip6assign

echo "--- 步骤 4: 关闭 'lan' 接口的 DHCP ---"
uci set dhcp.lan.ignore='1'

echo "--- 步骤 5: 删除 'wan' 接口和区域 ---"
uci -q delete network.wan
uci -q delete network.wan6
uci -q delete firewall.wan

echo "--- 步骤 6: 配置 'IPTV' 接口 ---"
uci -q delete network.IPTV
uci set network.IPTV='interface'
uci set network.IPTV.proto='dhcp'
uci set network.IPTV.device='eth0.2' # 绑定到 VLAN 2 (WAN口)
uci set network.IPTV.defaultroute='0'
uci set network.IPTV.metric='20'

echo "--- 步骤 7: 配置 igmpproxy ---"
uci -q delete igmpproxy.igmpproxy
uci set igmpproxy.igmpproxy='igmpproxy'
uci set igmpproxy.igmpproxy.quickleave='1'
while uci -q delete igmpproxy.@phyint[0]; do :; done
uci add igmpproxy phyint
uci set igmpproxy.igmpproxy.@phyint[-1].network='IPTV'
uci set igmpproxy.igmpproxy.@phyint[-1].direction='upstream'
uci add_list igmpproxy.igmpproxy.@phyint[-1].altnet='0.0.0.0/0'
uci add igmpproxy phyint
uci set igmpproxy.igmpproxy.@phyint[-1].network='lan'
uci set igmpproxy.igmpproxy.@phyint[-1].direction='downstream'

echo "--- 步骤 8: 配置 udpxy (并移除致命的 'bind' 选项) ---"
uci set udpxy.udpxy.disabled='0'
uci set udpxy.udpxy.status='1'
uci set udpxy.udpxy.port='4022'
uci set udpxy.udpxy.source='eth0.2'
uci -q delete udpxy.udpxy.bind # <--- 关键 BUG 修复！删除此行！
uci commit udpxy # 立即提交对 udpxy 文件的修改

echo "--- 步骤 9: 配置防火墙 ---"
uci -q delete firewall.iptv
uci set firewall.iptv='zone'
uci set firewall.iptv.name='iptv'
uci set firewall.iptv.input='ACCEPT'
uci set firewall.iptv.output='ACCEPT'
uci set firewall.iptv.forward='REJECT'
uci set firewall.iptv.masq='1'
uci set firewall.iptv.mtu_fix='1'
uci add_list firewall.iptv.network='IPTV'
uci add_list firewall.iptv.forwarding_to='lan'

uci -q delete firewall.Allow_IGMP
uci -q delete firewall.Allow_Multicast
uci -q delete firewall.Allow_udpxy_LAN

uci add firewall rule
uci set firewall.@rule[-1].name='Allow-IGMP'
uci set firewall.@rule[-1].src='iptv'
uci set firewall.@rule[-1].proto='igmp'
uci set firewall.@rule[-1].target='INPUT'

uci add firewall rule
uci set firewall.@rule[-1].name='Allow-Multicast'
uci set firewall.@rule[-1].src='iptv'
uci set firewall.@rule[-1].dest='lan'
uci set firewall.@rule[-1].proto='udp'
uci set firewall.@rule[-1].dest_ip='224.0.0.0/4'
uci set firewall.@rule[-1].target='ACCEPT'

uci add firewall rule
uci set firewall.@rule[-1].name='Allow-udpxy-LAN'
uci set firewall.@rule[-1].src='lan'
uci set firewall.@rule[-1].dest_port='4202'
uci set firewall.@rule[-1].proto='tcp'
uci set firewall.@rule[-1].target='INPUT'

echo "--- 步骤 10: 提交配置并重启服务 ---"
uci commit network
uci commit igmpproxy
uci commit firewall

echo ""
echo "==================================================================="
echo "配置已提交！网络服务将在 5 秒后重启。"
echo "您将从 192.168.1.1 断开连接。"
echo "请更改物理连接，然后通过 http://192.168.0.210 访问。"
echo "==================================================================="
sleep 5

/etc/init.d/network restart
/etc/init.d/firewall restart
/etc/init.d/igmpproxy enable
/etc/init.d/igmpproxy restart
/etc/init.d/udpxy enable
/etc/init.d/udpxy restart

echo "--- 脚本执行完毕 ---"
echo "请通过 http://192.168.0.210:4022/status 验证服务"
```
